function [ coord,dxdxi,d2xdxi2,dxdxi2] = paramMapSemiSphere3(PHUTelem, patchIndex,elemIndex, u_hat, v_hat)

%maps (u_hat, v_hat, w_hat) from the reference coordinate, to physical space using the geometry

xS = @(x,y,z) x*sqrt(1-(y^2/2)-(z^2/2)+(y^2*z^2/3));
yS = @(x,y,z) y*sqrt(1-(z^2/2)-(x^2/2)+(z^2*x^2/3));
zS = @(x,y,z) z*sqrt(1-(x^2/2)-(y^2/2)+(x^2*y^2/3));

% dxS = @(x,y,z) sqrt(12*(y^2)*(z^2)-18*(y^2)-18*(z^2)+36)/6;
% dyS = @(x,y,z) sqrt(12*(z^2)*(x^2)-18*(x^2)-18*(z^2)+36)/6;
% dzS = @(x,y,z) sqrt(12*(x^2)*(y^2)-18*(x^2)-18*(y^2)+36)/6;

xmin=PHUTelem{patchIndex}(elemIndex).vertex(1);
ymin=PHUTelem{patchIndex}(elemIndex).vertex(2);
xmax=PHUTelem{patchIndex}(elemIndex).vertex(3);
ymax=PHUTelem{patchIndex}(elemIndex).vertex(4);

%map (u_hat, v_hat) on [-1, 1]x[-1,1] to (xi, eta) on [xmin, xmax]x[ymin,
%ymax]
temp_xi = u_hat*(xmax-xmin)/2+(xmax+xmin)/2; %temp_xi=u
temp_eta = v_hat*(ymax-ymin)/2+(ymax+ymin)/2;  %temp_eta=v

xi=2*temp_xi-1;
eta=2*temp_eta-1;

%=============================================
if patchIndex==5
    %map (xi, eta) to sphere space
    
    
    plotZ=1; %up
    xiS=xS(xi, eta, plotZ);
    etaS =yS(xi, eta,plotZ);
    zetaS =zS(xi, eta, plotZ);
    
    u=temp_xi;
    v=temp_eta;
    dxdu = 2*(1/2 - (2*v - 1)^2/6)^(1/2);
    dxdv = -((2*u - 1)*((4*v)/3 - 2/3))/(2*(1/2 - (2*v - 1)^2/6)^(1/2));
    
    dydu = -(((4*u)/3 - 2/3)*(2*v - 1))/(2*(1/2 - (2*u - 1)^2/6)^(1/2));
    dydv = 2*(1/2 - (2*u - 1)^2/6)^(1/2);
    
    dzdu = (((8*u - 4)*(2*v - 1)^2)/3 - 4*u + 2)/(2*(((2*u - 1)^2*(2*v - 1)^2)/3 - (2*u - 1)^2/2 - (2*v - 1)^2/2 + 1)^(1/2));
    dzdv =(((2*u - 1)^2*(8*v - 4))/3 - 4*v + 2)/(2*(((2*u - 1)^2*(2*v - 1)^2)/3 - (2*u - 1)^2/2 - (2*v - 1)^2/2 + 1)^(1/2));
    
    d2xdu2 =0;
    d2xdudv =-((4*v)/3 - 2/3)/(1/2 - (2*v - 1)^2/6)^(1/2);
    d2xdv2 =- (2*(2*u - 1))/(3*(1/2 - (2*v - 1)^2/6)^(1/2)) - ((2*u - 1)*((4*v)/3 - 2/3)^2)/(4*(1/2 - (2*v - 1)^2/6)^(3/2));
    
    
    d2ydu2 =- (2*(2*v - 1))/(3*(1/2 - (2*u - 1)^2/6)^(1/2)) - (((4*u)/3 - 2/3)^2*(2*v - 1))/(4*(1/2 - (2*u - 1)^2/6)^(3/2)) ;
    d2ydudv =-((4*u)/3 - 2/3)/(1/2 - (2*u - 1)^2/6)^(1/2);
    d2ydv2 =0;
    
    
    d2zdu2 =((8*(2*v - 1)^2)/3 - 4)/(2*(((2*u - 1)^2*(2*v - 1)^2)/3 - (2*u - 1)^2/2 - (2*v - 1)^2/2 + 1)^(1/2)) - (((8*u - 4)*(2*v - 1)^2)/3 - 4*u + 2)^2/(4*(((2*u - 1)^2*(2*v - 1)^2)/3 - (2*u - 1)^2/2 - (2*v - 1)^2/2 + 1)^(3/2)) ;
    d2zdudv =((8*u - 4)*(8*v - 4))/(6*(((2*u - 1)^2*(2*v - 1)^2)/3 - (2*u - 1)^2/2 - (2*v - 1)^2/2 + 1)^(1/2)) - ((((8*u - 4)*(2*v - 1)^2)/3 - 4*u + 2)*(((2*u - 1)^2*(8*v - 4))/3 - 4*v + 2))/(4*(((2*u - 1)^2*(2*v - 1)^2)/3 - (2*u - 1)^2/2 - (2*v - 1)^2/2 + 1)^(3/2));
    d2zdv2 =((8*(2*u - 1)^2)/3 - 4)/(2*(((2*u - 1)^2*(2*v - 1)^2)/3 - (2*u - 1)^2/2 - (2*v - 1)^2/2 + 1)^(1/2)) - (((2*u - 1)^2*(8*v - 4))/3 - 4*v + 2)^2/(4*(((2*u - 1)^2*(2*v - 1)^2)/3 - (2*u - 1)^2/2 - (2*v - 1)^2/2 + 1)^(3/2));
elseif patchIndex==6
    %map (xi, eta) to sphere space
    
    
    plotZ=-1; %up
    xiS=xS(xi, eta, plotZ);
    etaS =yS(xi, eta,plotZ);
    zetaS =zS(xi, eta, plotZ);
    
    u=temp_xi;
    v=temp_eta;
    dxdu = 2*(1/2 - (2*v - 1)^2/6)^(1/2);
    dxdv = -((2*u - 1)*((4*v)/3 - 2/3))/(2*(1/2 - (2*v - 1)^2/6)^(1/2));
    
    dydu = -(((4*u)/3 - 2/3)*(2*v - 1))/(2*(1/2 - (2*u - 1)^2/6)^(1/2));
    dydv = 2*(1/2 - (2*u - 1)^2/6)^(1/2);
    
    dzdu = (((8*u - 4)*(2*v - 1)^2)/3 - 4*u + 2)/(2*(((2*u - 1)^2*(2*v - 1)^2)/3 - (2*u - 1)^2/2 - (2*v - 1)^2/2 + 1)^(1/2));
    dzdv =(((2*u - 1)^2*(8*v - 4))/3 - 4*v + 2)/(2*(((2*u - 1)^2*(2*v - 1)^2)/3 - (2*u - 1)^2/2 - (2*v - 1)^2/2 + 1)^(1/2));
    
    d2xdu2 =0;
    d2xdudv =-((4*v)/3 - 2/3)/(1/2 - (2*v - 1)^2/6)^(1/2);
    d2xdv2 =- (2*(2*u - 1))/(3*(1/2 - (2*v - 1)^2/6)^(1/2)) - ((2*u - 1)*((4*v)/3 - 2/3)^2)/(4*(1/2 - (2*v - 1)^2/6)^(3/2));
    
    
    d2ydu2 =- (2*(2*v - 1))/(3*(1/2 - (2*u - 1)^2/6)^(1/2)) - (((4*u)/3 - 2/3)^2*(2*v - 1))/(4*(1/2 - (2*u - 1)^2/6)^(3/2)) ;
    d2ydudv =-((4*u)/3 - 2/3)/(1/2 - (2*u - 1)^2/6)^(1/2);
    d2ydv2 =0;
    
    
    d2zdu2 =((8*(2*v - 1)^2)/3 - 4)/(2*(((2*u - 1)^2*(2*v - 1)^2)/3 - (2*u - 1)^2/2 - (2*v - 1)^2/2 + 1)^(1/2)) - (((8*u - 4)*(2*v - 1)^2)/3 - 4*u + 2)^2/(4*(((2*u - 1)^2*(2*v - 1)^2)/3 - (2*u - 1)^2/2 - (2*v - 1)^2/2 + 1)^(3/2)) ;
    d2zdudv =((8*u - 4)*(8*v - 4))/(6*(((2*u - 1)^2*(2*v - 1)^2)/3 - (2*u - 1)^2/2 - (2*v - 1)^2/2 + 1)^(1/2)) - ((((8*u - 4)*(2*v - 1)^2)/3 - 4*u + 2)*(((2*u - 1)^2*(8*v - 4))/3 - 4*v + 2))/(4*(((2*u - 1)^2*(2*v - 1)^2)/3 - (2*u - 1)^2/2 - (2*v - 1)^2/2 + 1)^(3/2));
    d2zdv2 =((8*(2*u - 1)^2)/3 - 4)/(2*(((2*u - 1)^2*(2*v - 1)^2)/3 - (2*u - 1)^2/2 - (2*v - 1)^2/2 + 1)^(1/2)) - (((2*u - 1)^2*(8*v - 4))/3 - 4*v + 2)^2/(4*(((2*u - 1)^2*(2*v - 1)^2)/3 - (2*u - 1)^2/2 - (2*v - 1)^2/2 + 1)^(3/2));
    
    
elseif patchIndex==1
    
    %map (xi, eta) to sphere space
    %     xi=2*temp_xi-1;
    %     eta=temp_eta;
    
    plotY=-1; %front
    xiS=xS(xi,plotY, eta);
    etaS =yS(xi,plotY, eta);
    zetaS =zS(xi,plotY, eta);
    
    u=temp_xi;
    v=temp_eta;
    
    dxdu = 2*(1/2 - v^2/6)^(1/2);
    dxdv = -(v*(2*u - 1))/(6*(1/2 - v^2/6)^(1/2));
    
    dydu = -((v^2*(8*u - 4))/3 - 4*u + 2)/(2*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2));
    dydv = (v - (2*v*(2*u - 1)^2)/3)/(2*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2));
    
    dzdu = -(v*((4*u)/3 - 2/3))/(2*(1/2 - (2*u - 1)^2/6)^(1/2));
    dzdv = (1/2 - (2*u - 1)^2/6)^(1/2);
    
    d2xdu2 = 0;
    d2xdudv = -v/(3*(1/2 - v^2/6)^(1/2));
    d2xdv2 = -(2*u - 1)/(6*(1/2 - v^2/6)^(1/2)) - (v^2*(2*u - 1))/(36*(1/2 - v^2/6)^(3/2));
    
    d2ydu2 =((v^2*(8*u - 4))/3 - 4*u + 2)^2/(4*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(3/2)) - ((8*v^2)/3 - 4)/(2*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2));
    d2ydudv = -(v*(8*u - 4))/(3*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2)) - ((v - (2*v*(2*u - 1)^2)/3)*((v^2*(8*u - 4))/3 - 4*u + 2))/(4*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(3/2));
    d2ydv2 = (v - (2*v*(2*u - 1)^2)/3)^2/(4*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(3/2)) - ((2*(2*u - 1)^2)/3 - 1)/(2*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2));
    
    d2zdu2 =- (2*v)/(3*(1/2 - (2*u - 1)^2/6)^(1/2)) - (v*((4*u)/3 - 2/3)^2)/(4*(1/2 - (2*u - 1)^2/6)^(3/2));
    d2zdudv =-((4*u)/3 - 2/3)/(2*(1/2 - (2*u - 1)^2/6)^(1/2));
    d2zdv2 =0;
    
    
elseif patchIndex==3
    %map (xi, eta) to sphere space
    %     xi=2*temp_xi-1;
    %     eta=temp_eta;
    
    plotY=1; %back
    xiS=xS(xi,plotY, eta);
    etaS =yS(xi,plotY, eta);
    zetaS =zS(xi,plotY, eta);
    
    u=temp_xi;
    v=temp_eta;
    
    dxdu = 2*(1/2 - v^2/6)^(1/2);
    dxdv = -(v*(2*u - 1))/(6*(1/2 - v^2/6)^(1/2));
    
    dydu = ((v^2*(8*u - 4))/3 - 4*u + 2)/(2*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2));
    dydv = -(v - (2*v*(2*u - 1)^2)/3)/(2*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2));
    
    dzdu = -(v*((4*u)/3 - 2/3))/(2*(1/2 - (2*u - 1)^2/6)^(1/2));
    dzdv = (1/2 - (2*u - 1)^2/6)^(1/2);
    
    d2xdu2 =0;
    d2xdudv =-v/(3*(1/2 - v^2/6)^(1/2));
    d2xdv2 =- (2*u - 1)/(6*(1/2 - v^2/6)^(1/2)) - (v^2*(2*u - 1))/(36*(1/2 - v^2/6)^(3/2));
    
    d2ydu2 =((8*v^2)/3 - 4)/(2*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2)) - ((v^2*(8*u - 4))/3 - 4*u + 2)^2/(4*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(3/2));
    d2ydudv =(v*(8*u - 4))/(3*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2)) + ((v - (2*v*(2*u - 1)^2)/3)*((v^2*(8*u - 4))/3 - 4*u + 2))/(4*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(3/2));
    d2ydv2 =((2*(2*u - 1)^2)/3 - 1)/(2*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2)) - (v - (2*v*(2*u - 1)^2)/3)^2/(4*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(3/2));
    
    d2zdu2 =- (2*v)/(3*(1/2 - (2*u - 1)^2/6)^(1/2)) - (v*((4*u)/3 - 2/3)^2)/(4*(1/2 - (2*u - 1)^2/6)^(3/2));
    d2zdudv =-((4*u)/3 - 2/3)/(2*(1/2 - (2*u - 1)^2/6)^(1/2));
    d2zdv2 =0;
    
    
elseif patchIndex==4
    
    %map (xi, eta) to sphere space
    %     xi=2*temp_xi-1;
    %     eta=temp_eta;
    
    plotX=-1; %left
    xiS=xS(plotX,xi,eta);
    etaS =yS(plotX,xi,eta);
    zetaS =zS(plotX,xi,eta);
    
    u=temp_xi;
    v=temp_eta;
    
    dxdu = -((v^2*(8*u - 4))/3 - 4*u + 2)/(2*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2));
    dxdv = (v - (2*v*(2*u - 1)^2)/3)/(2*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2));
    
    dydu = 2*(1/2 - v^2/6)^(1/2);
    dydv = -(v*(2*u - 1))/(6*(1/2 - v^2/6)^(1/2));
    
    dzdu = -(v*((4*u)/3 - 2/3))/(2*(1/2 - (2*u - 1)^2/6)^(1/2));
    dzdv = (1/2 - (2*u - 1)^2/6)^(1/2);
    
    d2xdu2 =((v^2*(8*u - 4))/3 - 4*u + 2)^2/(4*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(3/2)) - ((8*v^2)/3 - 4)/(2*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2));
    d2xdudv =- (v*(8*u - 4))/(3*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2)) - ((v - (2*v*(2*u - 1)^2)/3)*((v^2*(8*u - 4))/3 - 4*u + 2))/(4*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(3/2));
    d2xdv2 =(v - (2*v*(2*u - 1)^2)/3)^2/(4*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(3/2)) - ((2*(2*u - 1)^2)/3 - 1)/(2*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2));
    
    d2ydu2 =0;
    d2ydudv =-v/(3*(1/2 - v^2/6)^(1/2));
    d2ydv2 =- (2*u - 1)/(6*(1/2 - v^2/6)^(1/2)) - (v^2*(2*u - 1))/(36*(1/2 - v^2/6)^(3/2));
    
    d2zdu2 =- (2*v)/(3*(1/2 - (2*u - 1)^2/6)^(1/2)) - (v*((4*u)/3 - 2/3)^2)/(4*(1/2 - (2*u - 1)^2/6)^(3/2));
    d2zdudv =-((4*u)/3 - 2/3)/(2*(1/2 - (2*u - 1)^2/6)^(1/2));
    d2zdv2 =0;
    
elseif patchIndex==2
    
    %map (xi, eta) to sphere space
    %     xi=2*temp_xi-1;
    %     eta=temp_eta;
    
    plotX=1; %right
    xiS=xS(plotX,xi,eta);
    etaS =yS(plotX,xi,eta);
    zetaS =zS(plotX,xi,eta);
    
    u=temp_xi;
    v=temp_eta;
    
    dxdu =((v^2*(8*u - 4))/3 - 4*u + 2)/(2*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2));
    dxdv =-(v - (2*v*(2*u - 1)^2)/3)/(2*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2));
    
    dydu =2*(1/2 - v^2/6)^(1/2);
    dydv =-(v*(2*u - 1))/(6*(1/2 - v^2/6)^(1/2));
    
    dzdu =-(v*((4*u)/3 - 2/3))/(2*(1/2 - (2*u - 1)^2/6)^(1/2));
    dzdv =(1/2 - (2*u - 1)^2/6)^(1/2);
    
    d2xdu2 =((8*v^2)/3 - 4)/(2*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2)) - ((v^2*(8*u - 4))/3 - 4*u + 2)^2/(4*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(3/2));
    d2xdudv =(v*(8*u - 4))/(3*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2)) + ((v - (2*v*(2*u - 1)^2)/3)*((v^2*(8*u - 4))/3 - 4*u + 2))/(4*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(3/2));
    d2xdv2 =((2*(2*u - 1)^2)/3 - 1)/(2*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(1/2)) - (v - (2*v*(2*u - 1)^2)/3)^2/(4*((v^2*(2*u - 1)^2)/3 - (2*u - 1)^2/2 - v^2/2 + 1)^(3/2));
    
    
    d2ydu2 =0;
    d2ydudv =-v/(3*(1/2 - v^2/6)^(1/2));
    d2ydv2 =- (2*u - 1)/(6*(1/2 - v^2/6)^(1/2)) - (v^2*(2*u - 1))/(36*(1/2 - v^2/6)^(3/2));
    
    
    d2zdu2 =- (2*v)/(3*(1/2 - (2*u - 1)^2/6)^(1/2)) - (v*((4*u)/3 - 2/3)^2)/(4*(1/2 - (2*u - 1)^2/6)^(3/2));
    d2zdudv =-((4*u)/3 - 2/3)/(2*(1/2 - (2*u - 1)^2/6)^(1/2));
    d2zdv2 =0;
    
    
end

coord=[xiS,etaS,zetaS];
dxdxi=[dxdu dydu dzdu; dxdv dydv dzdv];
d2xdxi2=[d2xdu2 d2ydu2 d2zdu2 ;d2xdudv d2ydudv d2zdudv; d2xdv2 d2ydv2 d2zdv2];
% dxdxi2 = [dxdxi(1,1)^2, 2*dxdxi(1,1)*dxdxi(1,2), dxdxi(1,2)^2;...
%     dxdxi(1,1)*dxdxi(2,1), dxdxi(1,1)*dxdxi(2,2)+dxdxi(1,2)*dxdxi(2,1), dxdxi(1,2)*dxdxi(2,2);...
%     dxdxi(2,1)^2, 2*dxdxi(2,1)*dxdxi(2,2), dxdxi(2,2)^2];
end